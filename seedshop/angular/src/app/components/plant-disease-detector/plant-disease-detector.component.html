<app-client-header></app-client-header>

<div class="plant-disease-detector">
  <div class="container py-5">
    <h1 class="text-center mb-4">
      <i class="fas fa-leaf text-success"></i>
      Chẩn Đoán Bệnh Cây Trồng
    </h1>
    <p class="text-center text-muted mb-5">
      Tải lên hình ảnh lá cây để phát hiện bệnh. Hỗ trợ 38 loại bệnh khác nhau.
    </p>

    <div class="row">
      <!-- Left Panel - Upload & Result -->
      <div class="col-md-8">
        <div class="card shadow-sm mb-4">
          <div class="card-body">
            <!-- Upload Section -->
            <div class="upload-section mb-4">
              <h5 class="card-title">
                <i class="fas fa-upload"></i>
                Tải Lên Hình Ảnh
              </h5>
              
              <div class="custom-file-upload">
                <input 
                  type="file" 
                  id="imageInput"
                  accept="image/*" 
                  (change)="onFileSelected($event)"
                  class="file-input"
                />
                <label for="imageInput" class="file-label">
                  <i class="fas fa-cloud-upload-alt"></i>
                  <span>{{ selectedFile ? selectedFile.name : 'Chọn hoặc kéo thả hình ảnh vào đây' }}</span>
                </label>
              </div>

              <!-- Image Preview -->
              <div *ngIf="imagePreview" class="image-preview mt-3">
                <img [src]="imagePreview" alt="Preview" class="img-fluid rounded" />
              </div>

              <!-- Action Buttons -->
              <div class="action-buttons mt-3" *ngIf="selectedFile">
                <button 
                  class="btn btn-primary btn-lg me-2"
                  (click)="analyzeImage()"
                  [disabled]="loading"
                >
                  <span *ngIf="loading" class="spinner-border spinner-border-sm me-2"></span>
                  <i *ngIf="!loading" class="fas fa-search"></i>
                  {{ loading ? 'Đang phân tích...' : 'Phân Tích' }}
                </button>
                <button 
                  class="btn btn-outline-secondary btn-lg"
                  (click)="reset()"
                  [disabled]="loading"
                >
                  <i class="fas fa-redo"></i>
                  Chọn Lại
                </button>
              </div>

              <!-- Error Message -->
              <div *ngIf="error" class="alert alert-danger mt-3" role="alert">
                <i class="fas fa-exclamation-triangle"></i>
                {{ error }}
              </div>
            </div>

            <!-- Result Section -->
            <div *ngIf="result" class="result-section">
              <hr>
              <h5 class="card-title">
                <i class="fas fa-clipboard-check"></i>
                Kết Quả Chẩn Đoán
              </h5>
              
              <div class="result-card" [ngClass]="'border-' + getConfidenceColor(result.confidence)">
                <div class="result-header">
                  <h4 class="mb-0">
                    <span *ngIf="result.label_vi; else engLabel">{{ result.label_vi }}</span>
                    <ng-template #engLabel>{{ result.label }}</ng-template>
                  </h4>
                  <span class="badge" [ngClass]="'bg-' + getConfidenceColor(result.confidence)">
                    {{ (result.confidence * 100).toFixed(2) }}% tin cậy
                  </span>
                </div>
                
                <div class="confidence-bar mt-3">
                  <div class="progress" style="height: 25px;">
                    <div 
                      class="progress-bar" 
                      [ngClass]="'bg-' + getConfidenceColor(result.confidence)"
                      [style.width.%]="result.confidence * 100"
                      role="progressbar"
                    >
                      {{ (result.confidence * 100).toFixed(1) }}%
                    </div>
                  </div>
                </div>

                <div class="result-info mt-3">
                  <small class="text-muted">
                    <i class="fas fa-clock"></i>
                    Thời gian: {{ result.timestamp | date:'dd/MM/yyyy HH:mm:ss' }}
                  </small>
                </div>
              </div>

              <!-- Disease Details Section -->
              <div *ngIf="result.disease_detail" class="disease-details mt-4">
                <h6 class="mb-3">
                  <i class="fas fa-info-circle text-info"></i> Thông Tin Chi Tiết
                </h6>

                <div class="detail-item mb-3">
                  <h6 class="text-secondary">
                    <i class="fas fa-microscope"></i> Đặc Điểm Nhận Dạng:
                  </h6>
                  <p class="ms-3">{{ result.disease_detail.characteristics }}</p>
                </div>

                <div class="detail-item mb-3">
                  <h6 class="text-secondary">
                    <i class="fas fa-virus"></i> Nguyên Nhân:
                  </h6>
                  <p class="ms-3">{{ result.disease_detail.causes }}</p>
                </div>

                <div class="detail-item mb-3">
                  <h6 class="text-secondary">
                    <i class="fas fa-shield-alt"></i> Cách Phòng Tránh:
                  </h6>
                  <p class="ms-3">{{ result.disease_detail.prevention }}</p>
                </div>

                <div class="detail-item">
                  <h6 class="text-secondary">
                    <i class="fas fa-pills"></i> Cách Điều Trị:
                  </h6>
                  <p class="ms-3">{{ result.disease_detail.treatment }}</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Right Panel - Info & History -->
      <div class="col-md-4">
        <!-- Information Card -->
        <div class="card shadow-sm mb-4">
          <div class="card-body">
            <h5 class="card-title">
              <i class="fas fa-info-circle"></i>
              Hướng Dẫn
            </h5>
            <ul class="info-list">
              <li>Chọn hình ảnh lá cây rõ ràng</li>
              <li>Độ phân giải tốt (tối thiểu 224x224px)</li>
              <li>Ánh sáng đầy đủ, không mờ</li>
              <li>Hỗ trợ: JPG, PNG, WebP</li>
            </ul>

            <div class="supported-plants">
              <h6 class="mt-3">Loại cây được hỗ trợ (14 loại):</h6>
              <div class="plant-tags">
                <span *ngFor="let plant of supportedPlants" class="badge bg-success m-1">
                  {{ plant }}
                </span>
              </div>
            </div>
          </div>
        </div>

        <!-- History Card -->
        <div class="card shadow-sm" *ngIf="history.length > 0">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h5 class="card-title mb-0">
                <i class="fas fa-history"></i>
                Lịch Sử
              </h5>
              <button 
                class="btn btn-sm btn-outline-danger"
                (click)="clearHistory()"
              >
                <i class="fas fa-trash"></i>
              </button>
            </div>

            <div class="history-list">
              <div 
                *ngFor="let item of history" 
                class="history-item"
              >
                <div class="d-flex justify-content-between">
                  <div>
                    <strong>
                      <span *ngIf="item.label_vi; else engLabelHistory">{{ item.label_vi }}</span>
                      <ng-template #engLabelHistory>{{ item.label }}</ng-template>
                    </strong>
                    <br>
                    <small class="text-muted">
                      {{ item.timestamp | date:'dd/MM HH:mm' }}
                    </small>
                  </div>
                  <span 
                    class="badge" 
                    [ngClass]="'bg-' + getConfidenceColor(item.confidence)"
                  >
                    {{ (item.confidence * 100).toFixed(0) }}%
                  </span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<app-client-footer></app-client-footer>
